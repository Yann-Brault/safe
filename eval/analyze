#!/bin/bash

for i in "$@"
do
case $i in
  -ds|--dynamic-shortcut)
    DS=true
  ;;
  -a|--abstract)
    ABSTRACT=true
  ;;
  --name=*)
    NAME="${i#*=}"
  ;;
esac
done

LODASH=$SAFE_HOME/tests/benchmarks/lodash4
JALANGI_TARGET=target.js

if [ $DS ]; then
  ./ds --no-instrument $@
  if ! [ $ABSTRACT ]; then
    exit
  fi
  JALANGI_TARGET=jalangi_target.js
  ./merge --target=JALANGI_TARGET $LODASH/tests/$NAME.js
else
  echo "Analyzing with SAFE..."
  timeout 5m $SAFE_HOME/bin/safe bugDetect -analyzer:exitReachable target.js > safe.result
  if [ $? -eq 124 ]; then
    echo "[Timeout] 5 minutes." >> safe.result
  fi
fi

if [[ $ABSTRACT ]] && [[ ! $NAME ]]; then
  touch jalangi.result
else
  echo "Analyzing with Jalangi..."
  node $JALANGI_HOME/src/js/commands/jalangi.js --inlineIID --inlineSource \
    --analysis $JALANGI_HOME/src/js/sample_analyses/ChainedAnalyses.js \
    --analysis $JALANGI_HOME/src/js/sample_analyses/pldi16/BranchCoverage.js \
    $JALANGI_TARGET > jalangi.result
fi
