#!/bin/bash

for i in "$@"
do
case $i in
  --no-instrument)
    NO_INSTRUMENT=true
  ;;
esac
done

if ! [ $NO_INSTRUMENT ]; then
  echo "Generating direct_vanilla.js... @ $DS_HOME"
  node $JALANGI_HOME/generate_direct_vanilla.js --analysis src/js/sample_analyses/ChainedAnalyses.js --analysis src/js/sample_analyses/dlint/DynamicShortcut.js $DS_HOME/engine.js
fi

echo "Start server..."
cd $DS_HOME
node server.js &
pid=$!
cd $SAFE_HOME/eval

echo "Analyzing with SAFE + DynamicShortcut..."
echo > $DS_HOME/ds-jalangi.result
timeout 5m $SAFE_HOME/bin/safe bugDetect -analyzer:dynamicShortcut -analyzer:exitReachable target.js > ds-safe.result
if [ $? -eq 124 ]; then
  echo "[Timeout] 5 minutes." >> ds-safe.result
fi
mv $DS_HOME/ds-jalangi.result .

echo "Killing the server..."
kill -9 $pid
