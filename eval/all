#!/bin/bash

TOTAL_START_TIME=$SECONDS

for i in "$@"
do
case $i in
  -a|--abstract)
    ABSTRACT=true
  ;;
esac
done

mkdir -p result
LOG=result/all.log
LODASH=$SAFE_HOME/tests/benchmarks/lodash4
if [ $ABSTRACT ]; then
  TEST=$LODASH/tests-rewritten
else
  TEST=$LODASH/tests
fi

echo > $LOG
for file in $TEST/*; do
  if [ -f "$file" ]; then
    echo "--------------------------------------------------" | tee -a $LOG
    echo "- Diff-Testing for $file" | tee -a $LOG
    echo "--------------------------------------------------" | tee -a $LOG
    START_TIME=$SECONDS

    ./run $@ $file 2>&1 | tee -a $LOG
    base=`basename $file`
    name="${base%.*}"
    mkdir -p result/$name
    mv *.result result/$name

    ELAPSED_TIME=`expr $SECONDS - $START_TIME`
    echo "$ELAPSED_TIME seconds elpased." | tee -a $LOG
  fi
done

node summary.js $@

TOTAL_ELAPSED_TIME=`expr $SECONDS - $TOTAL_START_TIME`
echo "--------------------------------------------------" | tee -a $LOG
echo "Total $TOTAL_ELAPSED_TIME seconds elapsed." | tee -a $LOG
