#!/bin/sh

DS_DIFF_TEST=$SAFE_HOME/tests/benchmarks/lodash4/ds-diff-test

echo "Generating direct_vanilla.js... @ $DS_HOME"
node $JALANGI_HOME/generate_direct_vanilla.js --analysis src/js/sample_analyses/ChainedAnalyses.js --analysis src/js/sample_analyses/dlint/DynamicShortcut.js $DS_HOME/engine.js

echo "Changed directory to $DS_HOME"
cd $DS_HOME

# INPUT: direct_vanilla.js, iidMap.json, function.json
echo "Start server..."
node server.js &
pid=$!

echo "Analyzing with SAFE + DynamicShortcut..."
echo > $DS_HOME/ds-jalangi.result
$SAFE_HOME/bin/safe bugDetect -analyzer:dynamicShortcut $DS_DIFF_TEST/merged.js > $DS_DIFF_TEST/ds-safe.result
mv $DS_HOME/ds-jalangi.result $DS_DIFF_TEST

echo "Killing the server..."
kill -9 $pid
