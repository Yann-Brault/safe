#!/bin/sh

DS_DIFF_TEST=$SAFE_HOME/tests/benchmarks/lodash4/ds-diff-test

echo "Changed directory to $DS_HOME"
cd $DS_HOME

# INPUT: direct_vanilla.js, iidMap.json, function.json
echo "Start server..."
node server.js &
pid=$!

echo "Analyzing with SAFE + DynamicShortcut..."
echo > $DS_HOME/ds-jalangi.result
timeout 5m $SAFE_HOME/bin/safe bugDetect -analyzer:dynamicShortcut $DS_DIFF_TEST/merged.js > $DS_DIFF_TEST/ds-safe.result
if [ $? -eq 124 ]; then
  echo "[Timeout] 5 minutes." >> $DS_DIFF_TEST/ds-safe.result
fi
mv $DS_HOME/ds-jalangi.result $DS_DIFF_TEST

echo "Analyzing with Jalangi..."
cp $DS_DIFF_TEST/merged_jalangi_.js .
node $JALANGI_HOME/src/js/commands/direct.js \
  --analysis $JALANGI_HOME/src/js/sample_analyses/ChainedAnalyses.js \
  --analysis $JALANGI_HOME/src/js/sample_analyses/pldi16/BranchCoverage.js \
  merged_jalangi_.js > jalangi.result
mv $DS_HOME/jalangi.result $DS_DIFF_TEST

echo "Killing the server..."
kill -9 $pid
